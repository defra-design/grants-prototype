{% extends 'layinghens/current/views/layouts/layout.html' %}

{% block pageTitle %}
    Potential grant funding
{% endblock %}

{% block content %}

{% set projectCost = data['cost'] | float %}

{% set grantAmount = projectCost | percent(40) %}

{% set birds = data['number-of-birds'] | float %}
{% set energy = data['energy'] | float %}
{% set solarCost = data['solar-cost'] | float %}

{% set totalProjectCost = solarCost + projectCost %}

{% set energyCap = birds * 0.005 %}

{% set solarFunding = solarCost * 0.25 %}

{% if energy > energyCap %}
    {% set solarFunding = ((solarCost / energy) * energyCap) * 0.25 %}
{% endif %}

{% set totalFunding = grantAmount | float + solarFunding | float %}
{% if totalFunding > 500000 %}
    {% set solarFunding = 500000 - grantAmount %}
    {% set totalFunding = 500000 %}
{% endif %} 

{% if grantAmount > 500000 %}
    {% set grantAmount = 500000 %}
{% endif %} 
            
<div class="govuk-grid-row">

        <div class="govuk-grid-column-two-thirds">

            <h1 class="govuk-heading-l">Potential grant funding</h1>

            {# <pre> 
               birds {{ birds }}
               energy {{ energy }}
               solar cost {{ solarCost | inPounds }}
               energy cap {{ energyCap }}
               solar funding {{ solarFunding | inPounds }}
                total funding {{ totalFunding | inPounds }} 
                grant amount {{ grantAmount | inPounds }}
                maths {{ solarFunding | float + grantAmount | float }}
            </pre> #}

            {% if grantAmount == 500000 %}
                <p>
                    The maximum grant you can apply for is £500,000.
                </p>

                {{ govukInsetText ({
                    text: 'You cannot apply for funding for a solar PV system if you have requested the maximum funding amount for housing project costs.'
                }) }}

            {% elseif totalFunding == 500000 %}

                <p>
                    You may be able to apply for a grant of up to {{ totalFunding | inPounds }}, based on the estimated cost of {{ totalProjectCost | inPounds }}.
                </p>
                 
                <p>
                    This grant amount combines:
                </p>

                <ul class="govuk-list govuk-list--bullet">
                    <li>
                        {{ grantAmount | inPounds }} for house costs (40% of {{ projectCost | inPounds }})
                    </li>

                    <li>
                        {{ solarFunding | inPounds }} for solar PV system costs
                    </li>
                </ul>

                <p>
                    As house costs take grant funding priority, you may be able to apply for a grant of up to {{ solarFunding | inPounds }} for a solar PV system. The maximum grant is £500,000.
                </p>
            
            {% elseif energyCap < energy %}
            
                <p>
                    You may be able to apply for a grant of up to {{ totalFunding | inPounds }}, based on the estimated cost of {{ totalProjectCost | inPounds }}.
                </p>

                <ul class="govuk-list govuk-list--bullet">
                    <li>
                        {{ grantAmount | inPounds }} for house costs (40% of {{ projectCost | inPounds }})
                    </li>

                    <li>
                        {{ solarFunding | inPounds }} for solar PV system costs
                    </li>
                </ul>

                {% set detailsContentHTML %}
                    <p>
                        Because you have told us that this project will house {{ birds | formatNumber }} birds, you can apply for funding for a solar PV system with a rating of up to {{ energyCap }}kW. Because you are installing a solar PV system with a higher energy rating ({{ energy }}kW), the difference must be self-funded.
                    </p>
                    <p>
                        Based on what you have told us, your solar PV system will cost {{ (solarCost | float / energy | float) | inPounds }} per kW.
                    </p>
                    <p>
                        As we can fund 25% of the cost of a solar PV system up to a rating of {{ energyCap }}kW, we have calculated the grant-fundable amount for the solar PV system to be {{ ((solarCost | float / energy | float) * energyCap | float) | inPounds }} ({{ (solarCost | float / energy | float) | inPounds }} multiplied by {{ energyCap }}kW).
                    </p>
                    <p>
                        As you can apply for 25% of the cost of a solar PV system up to a rating of {{ energyCap }}kW, you can apply for a grant of up to {{ solarFunding | inPounds }} for your solar PV project.
                    </p>
                    {{ govukTable({
                        caption: 'Solar PV funding calculation',
                        captionClasses: "govuk-table__caption--s",
                        firstCellIsHeader: false,
                        rows: [
                            [
                                {
                                    text: 'Number of birds'
                                },
                                {
                                    text: birds | formatNumber
                                }
                            ],
                            [
                                {
                                    text: 'Allowable solar PV system rating per 1000 birds'
                                },
                                {
                                    text: '5kW'
                                }
                            ],
                            [
                                {
                                    text: 'Allowable solar PV system rating for this project'
                                },
                                {
                                    text: energyCap + 'kW'
                                }
                            ],
                            [
                                {
                                    text: 'Actual solar PV system rating for this project'
                                },
                                {
                                    text: energy + 'kW'
                                }
                            ],
                            [
                                {
                                    text: 'Total solar PV system cost'
                                },
                                {
                                    text: solarCost | inPounds
                                }
                            ],
                            [
                                {
                                    text: 'Solar PV system cost per kW'
                                },
                                {
                                    text: (solarCost | float / energy | float) | inPounds
                                }
                            ],
                            [
                                {
                                    text: 'Grant-fundable amount for solar PV system'
                                },
                                {
                                    text: ((solarCost | float / energy | float) * energyCap | float) | inPounds
                                }
                            ],
                            [
                                {
                                    text: 'Grant funding allowable for the solar PV system for this project (25% of ' + ((solarCost | float / energy | float) * energyCap | float) | inPounds + ')'
                                },
                                {
                                    text: solarFunding | inPounds
                                }
                            ]
                        ]
                        }) }}
                {% endset %}
                
                {{ govukDetails({
                    summaryText: 'How is the solar PV funding calculated?',
                    html: detailsContentHTML
                }) }}

            {% else %}    

                <p>
                    You may be able to apply for a grant of up to {{ totalFunding | inPounds }}, based on the estimated cost of {{ totalProjectCost | inPounds }}.
                </p>
                 
                <p>
                    This grant amount combines:
                </p>

                <ul class="govuk-list govuk-list--bullet">
                    <li>
                        {{ grantAmount | inPounds }} for house costs (40% of {{ projectCost | inPounds }})
                    </li>

                    <li>
                        {{ solarFunding | inPounds }} for solar PV system costs (25% of {{ solarCost | inPounds }})
                    </li>
                </ul>

            {% endif %}

            {{ govukWarningText({
                text: "There's no guarantee the project will receive a grant",
                iconFallbackText: "Warning"
            }) }}

            <form action="remaining-cost">

                <input type="hidden" name="potential-funding" value="{{ totalFunding }}">
                <input type="hidden" name="total-cost" value="{{ totalProjectCost }}">

                {{ govukButton ({
                    html: 'Continue'
                }) }}

            </form>

        </div>

</div>

{% endblock %}